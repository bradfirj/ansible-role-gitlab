# Complete gitlab.rb template from documentation at
# https://gitlab.com/gitlab-org/omnibus-gitlab/blob/master/files/gitlab-config-template/gitlab.rb.template

# Url on which GitLab will be reachable.
# For more details on configuring external_url see:
# https://gitlab.com/gitlab-org/omnibus-gitlab/blob/629def0a7a26e7c2326566f0758d4a27857b52a3/README.md#configuring-the-external-url-for-gitlab
external_url "{{ gitlab_external_url }}"

############################
# gitlab.yml configuration #
############################

{% if gitlab_rails.ssh_host is defined %}
gitlab_rails['gitlab_ssh_host'] = "{{ gitlab_rails.ssh_host }}"'
{% endif %}

gitlab_rails['time_zone'] = "{{ gitlab_rails.time_zone }}"

{% if gitlab_rails.email_from is defined %}
gitlab_rails['gitlab_email_from'] = "{{ gitlab_rails.email_from }}"
{% endif %}

gitlab_rails['gitlab_default_projects_limit'] = {{ gitlab_rails.default_projects_limit }}
gitlab_rails['gitlab_default_can_create_group'] = {{ gitlab_rails.default_can_create_group }}
gitlab_rails['gitlab_username_changing_enabled'] = {{ gitlab_rails.username_changing_enabled }}
gitlab_rails['gitlab_default_theme'] = {{ gitlab_rails.default_theme }}
gitlab_rails['gitlab_signup_enabled'] = {{ gitlab_rails.signup_enabled }}
gitlab_rails['gitlab_signin_enabled'] = {{ gitlab_rails.signin_enabled }}

# to restrict public and internal: ['public', 'internal']
gitlab_rails['gitlab_restricted_visibility_levels'] = {{ gitlab_rails.restricted_visibility_levels }}
gitlab_rails['gitlab_default_projects_features_issues'] = {{ gitlab_rails.default_projects_features.issues }}
gitlab_rails['gitlab_default_projects_features_merge_requests'] = {{ gitlab_rails.default_projects_features.merge_requests }}
gitlab_rails['gitlab_default_projects_features_wiki'] = {{ gitlab_rails.default_projects_features.wiki }}
gitlab_rails['gitlab_default_projects_features_snippets'] = {{ gitlab_rails.default_projects_features.snippets }}
gitlab_rails['gitlab_default_projects_features_visibility_level'] = '{{ gitlab_rails.default_projects_features.visibility_level }}'
gitlab_rails['gitlab_repository_downloads_path'] = '{{ gitlab_rails.repository_downloads_path }}'
{% if gitlab_rails.issues_tracker.redmine == "true" %}
gitlab_rails['issues_tracker_redmine'] = {{ gitlab_rails.issues_tracker.redmine }}
gitlab_rails['issues_tracker_redmine_title'] = "{{ gitlab_rails.issues_tracker.redmine_title }}"
gitlab_rails['issues_tracker_redmine_project_url'] = "{{ gitlab_rails.issues_tracker.redmine_project_url }}"
gitlab_rails['issues_tracker_redmine_issues_url'] = "{{ gitlab_rails.issues_tracker.redmine_issues_url }}"
gitlab_rails['issues_tracker_redmine_new_issue_url'] = "{{ gitlab_rails.issues_tracker.redmine_new_issue_url }}"
{% endif %}

{% if gitlab_rails.issues_tracker.jira == "true" %}
gitlab_rails['issues_tracker_jira'] = {{ gitlab_rails.issues_tracker.jira }}
gitlab_rails['issues_tracker_jira_title'] = "{{ gitlab_rails.issues_tracker.jira_title }}"
gitlab_rails['issues_tracker_jira_project_url'] = "{{ gitlab_rails.issues_tracker.jira_project_url }}"
gitlab_rails['issues_tracker_jira_issues_url'] = "{{ gitlab_rails.issues_tracker.jira_issues_url }}"
gitlab_rails['issues_tracker_jira_new_issue_url'] = "{{ gitlab_rails.issues_tracker.jira_new_issue_url }}"
{% endif %}

gitlab_rails['gravatar_enabled'] = {{ gitlab_rails.gravatar_enabled }}
gitlab_rails['gravatar_plain_url'] = "{{ gitlab_rails.gravatar_plain_url }}"
gitlab_rails['gravatar_ssl_url'] = "{{ gitlab_rails.gravatar_ssl_url }}"
gitlab_rails['webhook_timeout'] = {{ gitlab_rails.webhook_timeout }}


{% if gitlab_rails.ldap_enabled == "true" %}
## For setting up LDAP
## see https://gitlab.com/gitlab-org/omnibus-gitlab/blob/629def0a7a26e7c2326566f0758d4a27857b52a3/README.md#setting-up-ldap-sign-in
gitlab_rails['ldap_enabled'] = {{ gitlab_rails.ldap_enabled }}
gitlab_rails['ldap_servers'] = YAML.load <<-'EOS'
{% for server in gitlab_rails.ldap_servers %}
  {{ server.provider_id }}:
    label: '{{ server.label }}'
    host: '{{ server.host }}'
    port: {{ server.port }}
    uid: '{{ server.uid }}'
    method: '{{ server.method }}'
    bind_dn: '{{ server.bind_dn }}'
    password: '{{ server.password }}'
    active_directory: {{ server.active_directory }}
    allow_username_or_email_login: {{ server.allow_username_or_email_login }}
    base: '{{ server.base }}'
    user_filter: '{{ server.user_filter }}'
    ## EE only
    group_base: '{{ server.group_base }}'
    admin_group: '{{ server.admin_group }}'
    sync_ssh_keys: {{ server.sync_ssh_keys }}

{% endfor %}
EOS
{% endif %}

# Whether to redirect http to https.
nginx['redirect_http_to_https'] = {{ gitlab_redirect_http_to_https }}
nginx['ssl_certificate'] = "{{ gitlab_ssl_certificate }}"
nginx['ssl_certificate_key'] = "{{ gitlab_ssl_certificate_key }}"

# The directory where Git repositories will be stored.
git_data_dir "{{ gitlab_git_data_dir }}"

# To change other settings, see:
# https://gitlab.com/gitlab-org/omnibus-gitlab/blob/master/README.md#changing-gitlab-yml-settings
